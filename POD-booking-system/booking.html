<!DOCTYPE html>
<html lang="vi">

<head>

    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <link rel="preconnect" href="https://fonts.gstatic.com" />
        <link
            href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap"
            rel="stylesheet" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

        <title>Booking-BD.COM</title>

        <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />

        <link rel="stylesheet" href="assets/css/fontawesome.css" />
        <link rel="stylesheet" href="assets/css/templatemo-plot-listing.css" />
        <link rel="stylesheet" href="assets/css/animated.css" />
        <link rel="stylesheet" href="assets/css/owl.css" />
        <link rel="stylesheet" href="assets/css/index.css" />
        <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js"></script>
        <link rel="stylesheet" href="assets/css/booking.css" />
        <link rel="stylesheet" href="assets/css/index.css" />
    </head>

    <div id="js-preloader" class="js-preloader">
        <div class="preloader-inner">
            <span class="dot"></span>
            <div class="dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </div>

    <header class="header-area header-sticky wow slideInDown" data-wow-duration="0.75s" data-wow-delay="0s">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <nav class="main-nav">
                        <!-- ***** Logo Start ***** -->
                        <a href="index.html" class="logo"></a>
                        <!-- ***** Logo End ***** -->
                        <!-- ***** Menu Start ***** -->
                        <ul class="nav">
                            <li><a href="index.html" class="active">Home</a></li>
                            <li><a href="aboutus.html">About Us</a></li>
                            <li><a href="listing.html">Listing</a></li>
                            <li><a href="contact.html">Contact Us</a></li>

                            <!-- Login Button Placeholder (Add an actual button here) -->
                            <ul>
                                <li id="loginButtonContainer">
                                    <div class="main-white-button">
                                        <a href="login.html"><i class="fa fa-plus"></i> Log in</a>
                                    </div>
                                </li>
                                <li id="usernameContainer" style="display: none">
                                    <div class="nav-right-side">
                                        <button class="mode-switch">
                                            <svg class="sun" fill="none" stroke="#fbb046" stroke-linecap="round"
                                                stroke-linejoin="round" stroke-width="2" class="feather feather-sun"
                                                viewBox="0 0 24 24">
                                                <defs />
                                                <circle cx="12" cy="12" r="5" />
                                                <path
                                                    d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
                                            </svg>
                                            <svg class="moon" fill="none" stroke="#ffffff" stroke-linecap="round"
                                                stroke-linejoin="round" stroke-width="2" class="feather feather-moon"
                                                viewBox="0 0 24 24">
                                                <defs />
                                                <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
                                            </svg>
                                        </button>
                                        <button class="profile-btn" id="profileButton">
                                            <span id="loggedInUsername"></span>
                                            <img src="https://images.unsplash.com/photo-1492633397843-92adffad3d1c?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=2167&q=80"
                                                alt="profile picture" />
                                        </button>
                                    </div>
                                </li>
                            </ul>
                        </ul>
                        <a class="menu-trigger">
                            <span>Menu</span>
                        </a>
                        <!-- ***** Menu End ***** -->
                    </nav>
                </div>
            </div>
        </div>
    </header>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const username = localStorage.getItem("username");
            const loginButtonContainer = document.getElementById(
                "loginButtonContainer"
            );
            const usernameContainer = document.getElementById("usernameContainer");
            const loggedInUsername = document.getElementById("loggedInUsername");

            if (username) {
                loggedInUsername.textContent = `Welcome, ${username}`;
                loginButtonContainer.style.display = "none"; // Hide login button
                usernameContainer.style.display = "block"; // Show username
            } else {
                loginButtonContainer.style.display = "block"; // Show login button if not logged in
                usernameContainer.style.display = "none"; // Hide username if not logged in
            }
        });
    </script>

    <script>
        document
            .getElementById("profileButton")
            .addEventListener("click", function () {
                window.location.href = "profile.html";
            });
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Room Booking</title>
</head>

<body>
    <div class="booking-container">
        <h1>BOOKING</h1>
        <div class="room-container">
            <!-- Hình ảnh phòng bên trái -->
            <div class="room-image">
                <img src="assets/images/listing-01.jpg" alt="Room Image" />
            </div>

            <!-- Thông tin phòng bên phải -->
            <div class="room-info">
                <h2 class="title">Room 101</h2>
                <p class="agent">by: Real ESTATE Agent</p>

                <p class="price">400000 VND/H</p>

                <div class="section">
                    <p><strong>Room ID:</strong> R-01</p>
                    <p><strong>Capacity:</strong> 10 people</p>
                    <p><strong>Availability:</strong> AVAILABLE</p>
                    <p><strong>Type:</strong> Meeting room</p>
                </div>

                <div class="section">
                    <p><strong>Description:</strong> The room 19m² on the 1st floor</p>
                </div>

                <div class="section">
                    <p><strong>Available Date:</strong> 2024-10-15</p>
                </div>

                <button class="contact-btn" onclick="window.location.href='contact.html'">
                    <i class="fa fa-eye"></i> Contact Now
                </button>
            </div>
        </div>

        <div class="time-slot">
            <label for="time-option">Time slot:</label>
            <select id="time-option" onchange="showBookingOption()">
                <option value="hour">BOOK BY HOUR</option>
                <option value="day">BOOK BY DATE</option>
                <option value="month">BOOK BY MONTH</option>
            </select>
            <div id="booking-options"></div>
        </div>

        <div class="additional-services">
            <p style="color: white">Add more services:</p>
            <div id="services-list">
                <label class="service-item">
                    <div class="service-name">
                        <span>Cafe - 15,000đ</span>
                    </div>
                    <div class="service-controls">
                        <input type="number" class="quantity-input" value="1" min="1" onchange="calculateTotal(1)" />
                        <input type="checkbox" value="15000" onchange="calculateTotal(document.querySelector('.quantity-input').value)" />
                    </div>
                </label>

                <label class="service-item">
                    <div class="service-name">
                        <span>Print Service - 20,000đ</span>
                    </div>
                    <div class="service-controls">
                        <input type="number" class="quantity-input" value="1" min="1" onchange="calculateTotal()" />
                        <input type="checkbox" value="20000" onchange="calculateTotal()" />
                    </div>
                </label>

                <label class="service-item">
                    <div class="service-name">
                        <span>Additional Service - 25,000đ</span>
                    </div>
                    <div class="service-controls">
                        <input type="number" class="quantity-input" value="1" min="1" onchange="calculateTotal()" />
                        <input type="checkbox" value="25000" onchange="calculateTotal()" />
                    </div>
                </label>

                <label class="service-item">
                    <div class="service-name">
                        <span>Air Condition - 50,000đ</span>
                    </div>
                    <div class="service-controls">
                        <input type="number" class="quantity-input" value="1" min="1" onchange="calculateTotal()" />
                        <input type="checkbox" value="50000" onchange="calculateTotal()" />
                    </div>
                </label>

                <label class="service-item">
                    <div class="service-name">
                        <span>Projector - 100,000đ</span>
                    </div>
                    <div class="service-controls">
                        <input type="number" class="quantity-input" value="1" min="1" onchange="calculateTotal()" />
                        <input type="checkbox" value="100000" onchange="calculateTotal()" />
                    </div>
                </label>

                <label class="service-item">
                    <div class="service-name">
                        <span>Table - 30,000đ</span>
                    </div>
                    <div class="service-controls">
                        <input type="number" class="quantity-input" value="1" min="1" onchange="calculateTotal()" />
                        <input type="checkbox" value="30000" onchange="calculateTotal()" />
                    </div>
                </label>

                <label class="service-item">
                    <div class="service-name">
                        <span>Chair - 20,000đ</span>
                    </div>
                    <div class="service-controls">
                        <input type="number" class="quantity-input" value="1" min="1" onchange="calculateTotal()" />
                        <input type="checkbox" value="20000" onchange="calculateTotal()" />
                    </div>
                </label>
            </div>
        </div>
        <div class="total-cost">
            <p>
                <strong style="color: red">Total:</strong>
                <span id="total" style="color: red">0đ</span>
            </p>
        </div>

        <button class="payment-btn" id="paymentButton">PAYMENT</button>
    </div>
    <div id="roomModal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeRoomModal()">&times;</span>
    
          <div class="modal-container">
            <div class="modal-main">
              <h2 id="modalRoomName"></h2>
              
              <p><strong>Price:</strong> <span id="modalRoomPrice"></span></p>
              <div class="modal-buttons">
                <button id="bookNowButton" onclick="get_payment()">Book Now</button>
                <button onclick="getElementById()">Cancle</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    <script>
        // Function to display different booking options based on the selected time slot (hour, day, month)
        function showBookingOption() {
            const timeOption = document.getElementById("time-option").value;
            const bookingOptions = document.getElementById("booking-options");

            if (timeOption === "hour") {
                bookingOptions.innerHTML = `
                   <p style="color: white;">Select time slot:</p>
                   <select multiple style="color: white; background-color: #333; border: 1px solid #ccc; padding: 5px; border-radius: 5px; width: 100%;">
                      <option>6:00 - 7:00</option>
                      <option>7:00 - 8:00</option>
                      <option>8:00 - 9:00</option>
                      <option>9:00 - 10:00</option>
                  </select>
                `;
            } else if (timeOption === "day") {
                bookingOptions.innerHTML = `
                     <p style="color: white;">Select a date:</p>
                     <input type="date" id="booking-date" style="color: white; background-color: #333; border: 1px solid #ccc; padding: 8px; border-radius: 5px; width: 50%;">
                `;
            } else if (timeOption === "month") {
                bookingOptions.innerHTML = `
                     <p style="color: white;">Select a starting month:</p>
                     <input type="month" id="booking-month" style="color: white; background-color: #333; border: 1px solid #ccc; padding: 5px; border-radius: 5px;">
        
                     <p style="color: white;">Select number of months:</p>
                     <input type="number" id="month-duration" value="1" min="1" onchange="updateEndMonth()" style="color: white; background-color: #333; border: 1px solid #ccc; padding: 5px; border-radius: 5px;text-align:center">
        
                    <p style="color: white;"><strong>End month:</strong> <span id="end-month"></span></p>
                `;
                updateEndMonth();
            }
        }

        // Function to calculate the end month based on the starting month and number of months selected
        function updateEndMonth() {
            const startMonth = document.getElementById("booking-month").value;
            const duration = parseInt(
                document.getElementById("month-duration").value
            );
            const endMonthSpan = document.getElementById("end-month");

            if (startMonth) {
                const [year, month] = startMonth.split("-");
                const startDate = new Date(year, month - 1); // Create a date object with the start month
                startDate.setMonth(startDate.getMonth() + duration); // Add the duration in months
                const endMonth = `${startDate.getFullYear()}-${String(
                    startDate.getMonth() + 1
                ).padStart(2, "0")}`; // Format the end month
                endMonthSpan.innerText = endMonth;
            }
        }

        // Function to calculate the total cost based on selected services
        function calculateTotal(number_input) {
            let total = 0;
            const serviceItems = document.querySelectorAll('.service-item');
            serviceItems.forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const quantityInput = item.querySelector('input[type="number"]');
                if (checkbox.checked) {
                    const price = parseInt(checkbox.value, 10);
                    const quantity = parseInt(quantityInput.value, 10);
                    
                    total += price * quantity;
                }
            });
            document.getElementById("total").innerText =
                total.toLocaleString() + "đ";
        }

        //When the page loads, initiate the booking by calling /book and store the bookingId
        document.addEventListener("DOMContentLoaded", () => {
            fetch("/book", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({}), // Replace with actual data if needed
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Failed to initiate booking");
                    }
                    return response.json();
                })
                .then((data) => {
                    if (data.booking_id) {
                        localStorage.setItem("bookingId", data.booking_id); // Store bookingId
                    } else {
                        throw new Error("No booking ID returned");
                    }
                })
                .catch((error) => {
                    console.error("Error during booking initiation:", error);
                });
        });

        // When the Payment button is clicked, use the bookingId to call /bookingdetails
        document.querySelector(".payment-btn").addEventListener("click", () => {
            const bookingId = localStorage.getItem("bookingId");
            const roomName = "101"; // Replace with actual room name

            if (!bookingId) {
                console.error("No booking ID found. Please try again.");
                return;
            }

            fetch(`/bookingdetails/${bookingId}/${roomName}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    service: {
                        additionalProp1: 0, // Replace with actual service data
                        additionalProp2: 0,
                        additionalProp3: 0,
                    },
                    start_time: "2024-10-27", // Replace with actual start time
                    end_time: "2024-10-27", // Replace with actual end time
                    slots: {
                        additionalProp1: ["2024-10-27"], // Replace with actual data
                        additionalProp2: ["2024-10-27"],
                        additionalProp3: ["2024-10-27"],
                    },
                }),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Failed to retrieve booking details");
                    }
                    return response.json();
                })
                .then((data) => {
                    console.log("Booking details:", data);
                    // Handle payment success or redirect to confirmation
                })
                .catch((error) => {
                    console.error("Error during booking details retrieval:", error);
                });
        });
    </script>

    <div class="booking-container">
        <h1>Booking Details</h1>
        <p><strong>Booking ID:</strong> <span id="bookingId">Loading...</span></p>
        <p><strong>Room Name:</strong> <span id="roomName">Loading...</span></p>
        <p><strong>Total Price:</strong> <span id="totalPrice">Loading...</span></p>
        <p><strong>Details:</strong></p>
        <pre id="bookingDetails">Loading...</pre>
    
        <button id="paymentButton">Proceed to Payment</button>
    </div>

 <script>
        const params = new URLSearchParams(window.location.search);
        const buildingId = params.get("building_id");
        const room_id = params.get("roomId")
        const bookingId = params.get("bookingId");


        const apiUrl = `http://14.225.206.250:8080/POD_BookingSystem/rooms/building/${buildingId}`;
      fetch(apiUrl)
        .then((response) => response.json())
        .then((data) => {
          const roomsListContainer = document.getElementById("rooms-list");
          if (data && data.data.length > 0) {
            data.data.forEach((room) => {
                if(room_id == room.room_id){
                    const paragraph = document.querySelector('.section p');
                    if (paragraph && paragraph.childNodes.length > 1) {
                        paragraph.childNodes[1].nodeValue = room.description;
                    }   
                    const title = document.querySelector('.title');
                    title.textContent = room.name;
                    const price = document.querySelector('.price');
                    price.textContent = room.price + " VND/H";
                }
            });
            
          } else {
            
          }
        })
        .catch((error) => {
          
        });



        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                bookingId: params.get('booking_id'),
                roomName: params.get('room_name')
            };
        }

        function fetchBookingDetails(bookingId, roomName) {
            const apiUrl = `http://14.225.206.250:8080/POD_BookingSystem/${bookingId}/${roomName}/bookingdetails`;
            const bodyData = {
                "service": {
                    "Printer": 2
                },
                "start_time": "2024-10-28",
                "end_time": "2024-10-28",
                "slots": {
                    "Day": ["2024-10-28"]
                }
            };
            fetch(apiUrl,{
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(bodyData)})
                .then(response => response.json())
                .then(data => {
                    if (data.code === 1000 && data.data) {
                        document.getElementById("bookingId").textContent = bookingId;
                        document.getElementById("roomName").textContent = roomName;
                        document.getElementById("totalPrice").textContent = data.data.total_price + " VND";
                        document.getElementById("bookingDetails").textContent = JSON.stringify(data.data, null, 2);

                        //add modal value
                        document.getElementById("modalRoomName").textContent = roomName;
                        document.getElementById("modalRoomPrice").textContent = data.data.total_price + " VND/H";

                        document.getElementById("roomModal").style.display = "block";
                    } else {
                        throw new Error("Invalid booking details response");
                    }
                })
                .catch(error => {
                    console.error("Error fetching booking details:", error);
                    document.getElementById("bookingDetails").textContent = "Error loading booking details.";
                });
            }

        document.addEventListener("DOMContentLoaded", () => {
            const { bookingId, roomName } = getQueryParams();
            if (bookingId && roomName) {
                fetchBookingDetails(bookingId, roomName);
            } else {
                alert("Missing booking information");
            }
        });

        document.getElementById("paymentButton").onclick = () => {
           
            // call api bookding detail
            const params = new URLSearchParams(window.location.search);
            const bookingId = params.get("bookingId");
            const roomName = params.get("roomName");
            fetchBookingDetails(bookingId,roomName);
          


            // const vnpayApiUrl = "http://14.225.206.250:8080/POD_BookingSystem/vnpay-controller";
            // window.location.href = vnpayApiUrl; // Redirect to the VNPAY payment page
        };
        function closeRoomModal() {
            document.getElementById("roomModal").style.display = "none";
        }
        function get_payment(){
             const vnpayApiUrl = `http://14.225.206.250:8080/POD_BookingSystem/${bookingId}/api/payment`;
             const priceText = document.getElementById("modalRoomPrice").innerText;
             const price = priceText.match(/\d+/g)[0];
             const priceNumber = parseInt(price, 10);
             const bodyData = {
                "amount": priceNumber 
            };
            fetch(vnpayApiUrl,{
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(bodyData)})
                .then(response => response.json())
                .then(data => {
                    if (data.status == 'OK') {
                        window.location.href = data.url;
                    } else {
                        throw new Error("Invalid booking details response");
                    }
                })
                .catch(error => {
                    console.error("Error fetching booking details:", error);
                    document.getElementById("bookingDetails").textContent = "Error loading booking details.";
                });
            // window.location.href = vnpayApiUrl; // Redirect to the VNPAY payment page
        }
    </script>

    <!-- Scripts -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/owl-carousel.js"></script>
    <script src="assets/js/animation.js"></script>
    <script src="assets/js/imagesloaded.js"></script>
    <script src="assets/js/custom.js"></script>
</body>

</html>